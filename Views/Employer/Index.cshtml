@model StajyerPlatformu.ViewModels.EmployerDashboardViewModel

@{
    ViewData["Title"] = "İşveren Paneli";
}

<div class="container-fluid py-4 bg-light">
    <!-- Header with Tabs -->
    <div class="d-flex justify-content-between align-items-center mb-3">
         <div>
            <ul class="nav nav-pills" id="pills-tab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active fw-bold" id="pills-jobs-tab" data-bs-toggle="pill" data-bs-target="#pills-jobs" type="button" role="tab">İlanlar</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link fw-bold" id="pills-candidates-tab" data-bs-toggle="pill" data-bs-target="#pills-candidates" type="button" role="tab">Adaylar</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link fw-bold" id="pills-messages-tab" data-bs-toggle="pill" data-bs-target="#pills-messages" type="button" role="tab">Mesajlar</button>
              </li>

            </ul>
         </div>
         <div>
             <a asp-action="CreatePost" class="btn btn-primary rounded-pill px-4">+ Yeni İlan Oluştur</a>
         </div>
    </div>
    
    <div class="bg-white p-3 rounded-3 shadow-sm mb-4">
        <h5 class="fw-bold">Açık ve bekleyen ilanlar (@Model.Posts.Count)</h5>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-md-4">
             <div class="input-group">
                 <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                 <input type="text" class="form-control border-start-0 ps-0" placeholder="İlan başlığı ara...">
             </div>
        </div>
        <div class="col-md-4">
             <div class="input-group">
                 <span class="input-group-text bg-white border-end-0"><i class="bi bi-geo-alt text-muted"></i></span>
                 <input type="text" class="form-control border-start-0 ps-0" placeholder="Konum ara...">
             </div>
        </div>
        <div class="col-md-4 text-end">
            <span class="text-muted small me-2">Sırala:</span>
            <select class="form-select d-inline-block w-auto form-select-sm">
                <option>Yayınlanma Tarihi (Yeniden Eskiye)</option>
            </select>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="pills-tabContent">
        <!-- JOBS TAB -->
        <div class="tab-pane fade show active" id="pills-jobs" role="tabpanel">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr class="text-muted small text-uppercase">
                                <th class="ps-4">İlan Başlığı</th>
                                <th>Adaylar</th>
                                <th>İlan Durumu</th>
                                <th class="text-end pe-4">İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Posts)
                            {
                                <tr>
                                    <td class="ps-4 py-3">
                                        <div class="fw-bold">@item.Post.Title</div>
                                        <div class="text-muted small">Oluşturulma: @item.Post.CreatedDate.ToShortDateString()</div>
                                        <div class="text-muted small">Son Başvuru: @item.Post.Deadline.ToShortDateString()</div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center text-center">
                                            <div class="me-3">
                                                <div class="fw-bold text-primary">@item.ActiveCandidatesCount</div>
                                                <div class="small text-muted">Aktif Aday</div>
                                            </div>
                                            <div class="me-3 border-start ps-3">
                                                <div class="fw-bold">@item.AwaitingReviewCount</div>
                                                <div class="small text-muted">Bekleyen</div>
                                            </div>
                                            <div class="me-3 ps-2">
                                                 <div class="fw-bold text-primary">@item.ReviewedCount</div>
                                                 <div class="small text-muted">İncelenen</div>
                                            </div>
                                             <div class="me-3 ps-2">
                                                 <div class="fw-bold">@item.HiredCount</div>
                                                 <div class="small text-muted">İşe Alınan</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        @if(item.Post.IsActive) {
                                            <span class="badge rounded-pill bg-success bg-opacity-10 text-success border border-success px-3 py-2"><i class="bi bi-circle-fill small me-1"></i> Yayında</span>
                                        } else {
                                           <span class="badge rounded-pill bg-secondary bg-opacity-10 text-secondary border border-secondary px-3 py-2"><i class="bi bi-pause-fill small me-1"></i> Durduruldu</span>
                                        }
                                    </td>
                                    <td class="text-end pe-4">
                                        <div class="dropdown">
                                          <button class="btn btn-outline-secondary btn-sm dropdown-toggle rounded-pill" type="button" data-bs-toggle="dropdown">
                                            İşlemler
                                          </button>
                                          <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" asp-action="Applications" asp-route-id="@item.Post.Id">Adayları Gör</a></li>
                                            <li><a class="dropdown-item" asp-action="EditPost" asp-route-id="@item.Post.Id">Düzenle</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger" href="#">Yayından Kaldır</a></li>
                                          </ul>
                                        </div>
                                    </td>
                                </tr>
                            }
                            @if(!Model.Posts.Any())
                            {
                                 <tr>
                                     <td colspan="4" class="text-center py-5 text-muted">
                                         Henüz bir ilan yayınlamadınız.
                                     </td>
                                 </tr>
                            }
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- CANDIDATES TAB -->
        <div class="tab-pane fade" id="pills-candidates" role="tabpanel">
            @{
                var allApplications = Model.Posts
                    .Where(p => p.Post.Applications != null)
                    .SelectMany(p => p.Post.Applications)
                    .Where(a => a.InternProfile != null && a.InternProfile.AppUser != null && a.InternshipPost != null)
                    .OrderByDescending(a => a.ApplicationDate)
                    .ToList();
            }

            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h5 class="fw-bold mb-0">Tüm Aday Havuzu</h5>
                            <small class="text-muted">Tüm ilanlarınızdaki @allApplications.Count başvuruyu buradan yönetebilirsiniz.</small>
                        </div>
                    </div>

                    @if (!allApplications.Any())
                    {
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-people display-4 mb-3"></i>
                            <p>Henüz herhangi bir ilana başvuru yapılmamış.</p>
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr class="text-muted small text-uppercase">
                                        <th class="ps-3">Aday</th>
                                        <th>İlan</th>
                                        <th>Üniversite / Bölüm</th>
                                        <th>Başvuru Tarihi</th>
                                        <th>Durum</th>
                                        <th class="text-end pe-3">İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var app in allApplications)
                                    {
                                        <tr>
                                            <td class="ps-3">
                                                <div class="fw-bold">
                                                    @app.InternProfile.AppUser.FirstName @app.InternProfile.AppUser.LastName
                                                </div>
                                                <div class="small text-muted">
                                                    @app.InternProfile.AppUser.Email
                                                </div>
                                            </td>
                                            <td>
                                                <div class="fw-bold">@app.InternshipPost.Title</div>
                                                <div class="small text-muted">
                                                    Oluşturulma: @app.InternshipPost.CreatedDate.ToShortDateString()
                                                </div>
                                            </td>
                                            <td>
                                                <div>@app.InternProfile.University</div>
                                                <div class="small text-muted">@app.InternProfile.Department</div>
                                            </td>
                                            <td>@app.ApplicationDate.ToShortDateString()</td>
                                            <td>
                                                @switch (app.Status)
                                                {
                                                    case StajyerPlatformu.Models.ApplicationStatus.Pending:
                                                        <span class="badge bg-warning text-dark">Beklemede</span>
                                                        break;
                                                    case StajyerPlatformu.Models.ApplicationStatus.InReview:
                                                        <span class="badge bg-info text-dark">İnceleniyor</span>
                                                        break;
                                                    case StajyerPlatformu.Models.ApplicationStatus.Accepted:
                                                        <span class="badge bg-success">Kabul</span>
                                                        break;
                                                    case StajyerPlatformu.Models.ApplicationStatus.Rejected:
                                                        <span class="badge bg-danger">Reddedildi</span>
                                                        break;
                                                }
                                            </td>
                                            <td class="text-end pe-3">
                                            <div class="d-flex justify-content-end gap-1">
                                                    <a asp-action="CandidateDetail" asp-route-id="@app.InternProfileId" class="btn btn-sm btn-outline-primary" title="Detay">
                                                        <i class="bi bi-person"></i>
                                                    </a>

                                                    <a asp-controller="Messages"
                                                       asp-action="Create"
                                                       asp-route-receiverId="@app.InternProfile.AppUserId"
                                                       asp-route-subject="İlan başvurunuz hakkında"
                                                       class="btn btn-sm btn-outline-success"
                                                       title="Mesaj Gönder">
                                                        <i class="bi bi-envelope"></i>
                                                    </a>

                                                    @if (!string.IsNullOrEmpty(app.InternProfile.ResumePath))
                                                    {
                                                        <a href="@app.InternProfile.ResumePath" target="_blank" class="btn btn-sm btn-outline-secondary" title="CV İndir">
                                                            <i class="bi bi-file-earmark-pdf"></i>
                                                        </a>
                                                    }

                                                    <div class="dropdown">
                                                        <button class="btn btn-sm btn-light border dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                            <i class="bi bi-gear"></i>
                                                        </button>
                                                        <ul class="dropdown-menu dropdown-menu-end shadow">
                                                            @if (app.Status != StajyerPlatformu.Models.ApplicationStatus.Accepted)
                                                            {
                                                                <li>
                                                                    <form asp-action="AcceptApplication" method="post">
                                                                        <input type="hidden" name="id" value="@app.Id" />
                                                                        <button type="submit" class="dropdown-item text-success" onclick="return confirm('Bu başvuruyu kabul etmek istediğinize emin misiniz?');">
                                                                            <i class="bi bi-check-circle me-2"></i>Kabul Et
                                                                        </button>
                                                                    </form>
                                                                </li>
                                                            }
                                                            @if (app.Status != StajyerPlatformu.Models.ApplicationStatus.InReview)
                                                            {
                                                                <li>
                                                                    <form asp-action="SetApplicationInReview" method="post">
                                                                        <input type="hidden" name="id" value="@app.Id" />
                                                                        <button type="submit" class="dropdown-item text-info">
                                                                            <i class="bi bi-eye me-2"></i>İncelemeye Al
                                                                        </button>
                                                                    </form>
                                                                </li>
                                                            }
                                                            @if (app.Status != StajyerPlatformu.Models.ApplicationStatus.Rejected)
                                                            {
                                                                <li>
                                                                    <form asp-action="RejectApplication" method="post">
                                                                        <input type="hidden" name="id" value="@app.Id" />
                                                                        <button type="submit" class="dropdown-item text-danger" onclick="return confirm('Bu başvuruyu reddetmek istediğinize emin misiniz?');">
                                                                            <i class="bi bi-x-circle me-2"></i>Reddet
                                                                        </button>
                                                                    </form>
                                                                </li>
                                                            }
                                                        </ul>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- MESSAGES TAB -->
        <div class="tab-pane fade" id="pills-messages" role="tabpanel">
            <div class="row">
                <div class="col-md-12">
                    <div class="card border-0 shadow-sm p-4 text-center h-100">
                         <i class="bi bi-envelope display-4 text-muted mb-3"></i>
                         <h5>Mesajlar (@Model.TotalMessages)</h5>
                         <p class="text-muted mb-2">Stajyerlerden gelen mesajları görüntüleyin.</p>
                         <a asp-controller="Messages" asp-action="Inbox" class="btn btn-sm btn-primary">Gelen Kutusuna Git</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- INTERVIEWS TAB -->

    </div>
    
    <!-- Footer Section -->
    <div class="card mt-4 border-0 shadow-sm">
        <div class="card-body p-4">
            <h6 class="fw-bold">Kariyer Sayfası</h6>
            <div class="input-group">
                <input type="text" class="form-control" value="https://stajyerplatformu.com/kariyer/@(Model.Profile.Id)" readonly>
                <button class="btn btn-outline-secondary" type="button">Bağlantıyı Kopyala</button>
            </div>
             <div class="mt-3">
                 <span class="text-muted small me-2">İlanlarını paylaş:</span>
                 <a href="#" class="text-primary me-2"><i class="bi bi-facebook"></i></a>
                 <a href="#" class="text-info me-2"><i class="bi bi-linkedin"></i></a>
                 <a href="#" class="text-primary"><i class="bi bi-twitter"></i></a>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
