@model StajyerPlatformu.Models.InternProfile

@{
    ViewData["Title"] = "Saha Dashboard";
    var totalHours = Model.Experiences.Sum(e => e.TotalHours);
    var totalDays = (int)Model.Experiences.Sum(e => (e.EndDate.HasValue ? (e.EndDate.Value - e.StartDate).TotalDays : (DateTime.Now - e.StartDate).TotalDays));
    var experienceCount = Model.Experiences.Count;
}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container-fluid py-4">
    <div class="row">
        <!-- LEFT SIDEBAR -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center p-3 mb-4 sticky-top" style="top: 80px;">
                <div class="position-absolute top-0 end-0 p-2">
                    <a asp-action="CreateProfile" class="btn btn-sm btn-outline-secondary rounded-pill">Düzenle</a>
                </div>
                <div class="mx-auto mb-3">
                    @if (string.IsNullOrEmpty(Model.ProfilePhotoPath))
                    {
                         <img src="https://ui-avatars.com/api/?name=@(Model.AppUser.FirstName + "+" + Model.AppUser.LastName)&size=128" class="rounded-circle img-thumbnail" alt="Profile" />
                    }
                    else
                    {
                        <img src="@Model.ProfilePhotoPath" class="rounded-circle img-thumbnail" style="width: 128px; height: 128px; object-fit: cover;" alt="Profile" />
                    }
                </div>
                <h4>@Model.AppUser.FirstName @Model.AppUser.LastName</h4>
                
                <div class="mt-3 mb-2 d-grid">
                    <a asp-controller="Messages" asp-action="Inbox" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-envelope"></i> Mesajlarım
                    </a>
                </div>

                <hr />
                
                <div class="text-start px-2">
                    <h6 class="text-muted fw-bold">Öğrenci Bilgileri</h6>
                    <p class="mb-1"><small class="text-muted">Üniversite</small><br />@Model.University</p>
                    <p class="mb-1"><small class="text-muted">Bölüm</small><br />@Model.Department</p>
                    <p class="mb-1"><small class="text-muted">Sınıf</small><br />@Model.Grade</p>
                    <p class="mb-1"><small class="text-muted">Öğrenci No</small><br />@Model.StudentId</p>
                    <p class="mb-1"><small class="text-muted">Cinsiyet</small><br />@Model.Gender</p>
                    <p class="mb-1"><small class="text-muted">Doğum Tarihi</small><br />@Model.BirthDate?.ToShortDateString()</p>
                    <p class="mb-1"><small class="text-muted">Email</small><br />@Model.AppUser.Email</p>
                    @if(!string.IsNullOrEmpty(Model.LinkedIn)) {
                        <p class="mt-2 mb-1"><a href="@Model.LinkedIn" target="_blank" class="text-decoration-none"><i class="bi bi-linkedin"></i> LinkedIn Profili</a></p>
                    }
                    @if(!string.IsNullOrEmpty(Model.ResumePath)) {
                        <p class="mt-1"><a href="@Model.ResumePath" target="_blank" class="btn btn-sm btn-outline-primary w-100"><i class="bi bi-file-earmark-pdf"></i> CV İndir</a></p>
                    }
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="col-md-9">
            
            <!-- ROW 1: CHARTS -->
            <div class="row mb-4">
                <div class="col-md-12">
                     <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <h5 class="card-title">Profesyonel Saat Özeti</h5>
                            <p class="text-muted small">Meslekler kaydedilen saat sayısına göre sıralanmıştır.</p>
                            <div style="height: 250px; width: 100%; display: flex; align-items: center; justify-content: center;">
                                 <canvas id="hoursChart"></canvas>
                            </div>
                        </div>
                     </div>
                </div>
            </div>

            <!-- ROW 2: SUMMARY STATS -->
             <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-4">Deneyim Özeti</h5>
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="display-4 text-primary"><i class="bi bi-briefcase"></i></div>
                            <h4 class="fw-bold">@experienceCount</h4>
                            <p class="text-muted">deneyim</p>
                        </div>
                        <div class="col-md-4">
                             <div class="display-4 text-success"><i class="bi bi-calendar-check"></i></div>
                            <h4 class="fw-bold">@totalDays</h4>
                            <p class="text-muted">gün deneyim</p>
                        </div>
                        <div class="col-md-4">
                             <div class="display-4 text-warning"><i class="bi bi-clock-history"></i></div>
                            <h4 class="fw-bold">@totalHours</h4>
                            <p class="text-muted">kaydedilen saat</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ROW 3: EXPERIENCE LIST & ADD FORM -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                     <h5 class="mb-0">Deneyimler</h5>
                     <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addExperienceModal">+ Deneyim Ekle</button>
                </div>
                <div class="card-body">
                    @if (Model.Experiences.Any())
                    {
                        @foreach(var exp in Model.Experiences.OrderByDescending(e => e.StartDate))
                        {
                            <div class="d-flex mb-3 border-bottom pb-3">
                                <div class="me-3">
                                    <div class="bg-light rounded p-3 text-center" style="width: 80px;">
                                        <i class="bi bi-building fs-3 text-secondary"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="fw-bold mb-1">@exp.Title <span class="text-muted fw-normal"> - @exp.CompanyName</span></h6>
                                    <p class="small text-muted mb-1">
                                        @exp.StartDate.ToShortDateString() - @(exp.EndDate.HasValue ? exp.EndDate.Value.ToShortDateString() : "Halen")
                                    </p>
                                    <p class="mb-0">@exp.Description</p>
                                </div>
                                <div>
                                    <span class="badge bg-secondary">@exp.TotalHours saat</span>
                                    <form asp-action="DeleteExperience" class="d-inline ms-2">
                                        <input type="hidden" name="id" value="@exp.Id" />
                                        <button type="submit" class="btn btn-link text-danger p-0 border-0"><i class="bi bi-trash"></i></button>
                                    </form>
                                </div>
                            </div>
                        }
                    } 
                    else 
                    {
                        <p class="text-muted text-center py-4">Henüz deneyim eklenmemiş.</p>
                    }
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Modal for Add Experience -->
<div class="modal fade" id="addExperienceModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form asp-action="AddExperience" method="post">
          <div class="modal-header">
            <h5 class="modal-title">Yeni Deneyim Ekle</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
              <div class="mb-3">
                  <label class="form-label">Firma Adı</label>
                  <input type="text" name="CompanyName" class="form-control" required>
              </div>
              <div class="mb-3">
                  <label class="form-label">Pozisyon / Unvan</label>
                  <input type="text" name="Title" class="form-control" required>
              </div>
               <div class="row">
                   <div class="col-md-6 mb-3">
                      <label class="form-label">Başlangıç Tarihi</label>
                      <input type="date" name="StartDate" class="form-control" required>
                   </div>
                   <div class="col-md-6 mb-3">
                      <label class="form-label">Bitiş Tarihi</label>
                       <input type="date" name="EndDate" class="form-control">
                   </div>
               </div>
               <div class="mb-3">
                   <label class="form-label">Toplam Saat</label>
                   <input type="number" name="TotalHours" class="form-control" value="0">
               </div>
               <div class="mb-3">
                   <label class="form-label">Açıklama</label>
                   <textarea name="Description" class="form-control" rows="3"></textarea>
               </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            <button type="submit" class="btn btn-primary">Kaydet</button>
          </div>
      </form>
    </div>
  </div>
</div>

<!-- Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<script>
    // Data for Chart
    const ctx = document.getElementById('hoursChart');
    
    // Prepare data from model
    const labels = [];
    const dataPoints = [];
    
    @foreach(var group in Model.Experiences.GroupBy(e => e.Title))
    {
        @:labels.push("@Html.Raw(group.Key)");
        @:dataPoints.push(@group.Sum(e => e.TotalHours));
    }

    if (labels.length === 0) {
        labels.push("Veri Yok");
        dataPoints.push(1);
    }

    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          label: 'Kaydedilen Saat',
          data: dataPoints,
          borderWidth: 1,
          backgroundColor: [
            'rgb(255, 99, 132)',
            'rgb(54, 162, 235)',
            'rgb(255, 205, 86)',
            'rgb(75, 192, 192)',
            'rgb(153, 102, 255)'
          ],
        }]
      },
      options: {
        responsive: false, // Keep it contained
        maintainAspectRatio: false
      }
    });
</script>
